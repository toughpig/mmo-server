# 安全网关服务 - 加密通信

本文档描述了MMO游戏服务器框架中安全网关的加密通信机制，包括AES-GCM加密算法实现和密钥交换过程。

## 加密架构概述

网关服务采用了分层的安全设计，在传输层和应用层都提供了安全保障：

1. 传输层：基于TLS/DTLS的传输加密（可选）
2. 应用层：基于AES-GCM的消息级加密（本文档重点）

## AES-GCM加密实现

安全网关使用AES-GCM（Galois/Counter Mode）对称加密算法，这是一种高效的认证加密（AEAD）算法，同时提供了数据加密和完整性验证功能。

主要特性：

- 256位AES密钥，提供高强度加密
- 12字节随机生成的Nonce（仅使用一次的数字）
- 内置消息认证码（MAC），防止消息篡改
- 时间戳验证，防止重放攻击

### 加密流程

1. 客户端与服务器通过ECDHE（椭圆曲线Diffie-Hellman密钥交换）协商共享密钥
2. 每条消息使用共享密钥和唯一的Nonce进行加密
3. 加密消息包含时间戳和TTL（生存时间），用于防止重放攻击
4. 消息通过安全通道传输
5. 接收方解密消息并验证其完整性和时效性

### 密钥管理

- 会话密钥：每个客户端连接会创建唯一的会话密钥
- 密钥轮换：服务器定期（默认24小时）轮换ECDH密钥对
- 密钥存储：会话密钥仅存储在内存中，不持久化

## 安全握手流程

1. **客户端发起握手请求**:
   - 生成ECDH密钥对
   - 构造握手请求，包含公钥和会话ID
   - 发送握手请求给服务器

2. **服务器处理握手请求**:
   - 验证会话ID
   - 使用客户端公钥和服务器私钥计算共享密钥
   - 响应自己的公钥给客户端

3. **客户端完成握手**:
   - 使用服务器公钥和客户端私钥计算共享密钥
   - 此时双方拥有相同的共享密钥，可以开始加密通信

4. **加密通信阶段**:
   - 所有后续消息都使用AES-GCM加密
   - 每条消息包含消息类型、加密负载和时间戳

## 消息格式

### 握手消息

```
[消息类型(1字节)][握手类型(1字节)][消息长度(4字节)][握手消息内容]
```

握手消息内容（JSON格式）：
```json
{
  "type": 1,                   // 1=请求, 2=响应
  "public_key": "base64...",   // 公钥数据
  "session_id": "uuid...",     // 会话ID
  "version": "1.0"             // 协议版本
}
```

### 加密数据消息

```
[消息类型(1字节)][消息长度(4字节)][加密消息内容]
```

加密消息内容（JSON格式）：
```json
{
  "nonce": "base64...",        // 随机数
  "ciphertext": "base64...",   // 加密数据
  "session_id": "uuid..."      // 会话ID
}
```

解密后的明文格式：
```
[时间戳(8字节)][TTL(4字节)][实际负载]
```

## 防重放攻击

每条加密消息都包含时间戳和TTL，接收方在解密后会验证：

1. 消息是否已过期（当前时间 > 时间戳 + TTL）
2. 消息是否来自未来（当前时间 < 时间戳）

如果验证失败，消息将被丢弃，防止攻击者录制并回放有效消息。

## 实现代码位置

- `pkg/security/crypto.go`: 核心加密功能实现
- `pkg/gateway/secure_connection.go`: 安全连接封装
- `pkg/gateway/secure_websocket.go`: 安全WebSocket服务器

## 测试工具

安全通信可以使用以下测试工具进行验证：

```bash
# 启动支持加密的网关服务
./bin/gateway

# 使用安全客户端连接并测试
./bin/secure_ws_client -addr localhost:8081 -path /ws -n 5
```

## 安全性考虑

1. **前向保密性**: 使用ECDHE保证即使私钥泄露，过去的通信仍然安全
2. **重放保护**: 使用时间戳和TTL防止重放攻击
3. **数据完整性**: AES-GCM提供认证加密，能检测消息篡改
4. **密钥隔离**: 每个会话使用独立密钥，一个会话泄露不影响其他会话
5. **密钥轮换**: 定期轮换密钥对，限制单个密钥的暴露时间 